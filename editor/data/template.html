<html>

<head>
 <title>Dialogic</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<!--   <script src="http://rednoise.org/js/jquery-linedtextarea-dialogic.js"></script> -->
  <link href="http://files.aw20.net/jquery-linedtextarea/jquery-linedtextarea.css" rel="stylesheet" />
  <link href="https://jsonlint.com/css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.38.0/codemirror.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.38.0/codemirror.js"></script>
  <style>
    .CodeMirror {
      border: 1px solid #eee;
      min-height: 400px;
      line-height: 16px;
/*      height: auto;*/
    }

    body {
      padding: 0 2em;
    }

    .sub-title {
      line-height: 42px;
      font-size: 20px;
    }

    .input-area {
      margin-top: 5px !important;
    }

    #result-container pre {
      width: 95%;
      margin-left: 13px;
      min-width: 620px;
      overflow: auto;
    }

    #executeResult {
      border: 1px solid transparent;
      padding: 0.8em;
    }

    #executeResult:empty {
      display: none;
    }

    #executeResult.success {
      background: #c3d4ef;
      color: #144594;
      border-color: #7ea0d7;
    }

    #executeResult.error {
      background: #FBE3E4;
      color: #D12F19;
      border-color: #FBC2C4;
    }

    pre.executeResult {
      white-space: pre-wrap;
      /* Since CSS 2.1 */
      white-space: -moz-pre-wrap;
      /* Mozilla, since 1999 */
      white-space: -pre-wrap;
      /* Opera 4-6 */
      white-space: -o-pre-wrap;
      /* Opera 7 */
      word-wrap: break-word;
      /* Internet Explorer 5.5+ */
    }

    #loadURLDialog {
      width: 500px;
      border: 1px solid #c0c0c0;
      margin: auto;
      top: 300px;
      left: -600px;
      display: none;
      background-color: rgba(255, 255, 255, 0.95)
    }

    #closeDialog {
      float: right;
    }

    #loadUrlPathDiv input {
      margin: 10px 0;
      font-size: 14px;
      width: 100% !important;
    }

    button:disabled {
      opacity: .5;
    }

    button:disabled:hover {
      background: white !important;
    }

    .navlink:link,
    .navlink:visited {
      text-decoration: none;
      font-size: 12px;
      font-family: Open Sans, sans-serif;
      font-weight: 500;
      color: #2F6465;
    }

    .navlink:hover,
    .navlink:active {
      color: #088;
    }

    .button:hover,
    button[type="button"]:hover {
      background: #f3f3f3 !important;
    }

    p.navlinks {
      margin-left: 185px;
    }

    #button-div {
      margin-left: 100px;
    }

    #title {
      font-family: Open Sans, sans-serif;
      font-size: 24px;
      margin-left: -3px;
    }

    #fish {
      margin-top: 5px;
      margin-left: 13px;
    }

    linedwrap {
      width: 95% !important;
      min-width: 700px;
      margin-left: 13px;
    }

    #main {
      width: 90% !important;
    }

    .checkbox {
      margin-left: 3px;
      margin-top: 16px;
      -webkit-appearance: none;
      background-color: #fafafa;
      border: 1px solid #cacece;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05), inset 0px -15px 10px -12px rgba(0, 0, 0, 0.05);
      padding: 9px;
      border-radius: 3px;
      display: inline-block;
      position: relative;
    }

    .checkbox:active,
    .checkbox:checked:active {
      border: 1px solid #cacece;
    }

    .checkbox:checked {
      color: #99a1a7;
      border: 1px solid #cacece;
    }

    .checkbox:checked:after {
      content: '\2714';
      font-size: 14px;
      position: absolute;
      top: 0px;
      left: 3px;
      color: #99a1a7;
    }

    #checkText {
      margin-top: 13px;
      margin-left: 8px;
      display: inline-block;
      position: relative;
    }

    .button,
    button[type="button"] {
      cursor: pointer;
      background-color: #fff !important;
      padding: 5px 15px !important;
      text-decoration: none !important;
      border: 1px solid #e1e1e1 !important;
      font-size: 14px !important;
      font-family: Open Sans, sans-serif !important;
      font-weight: 500 !important;
      color: #333 !important;
      margin: 10px 20px 0 0 !important;
    }

    .handle {
      margin-top:-15px;
      background: #f7f7f7;
      height: 20px;
      user-select: none;
      cursor: row-resize;
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
    }

    .handle:before {
      content: '\2261'; /* https://en.wikipedia.org/wiki/Triple_bar */
      color: #999;
      position: absolute;
      left: 50%;
    }

    .handle:hover {
      background: #f0f0f0;
    }

    .handle:hover:before {
      color: #000;
    }

  </style>
</head>

<body>
  <span class="sub-title">
        <p class="navlinks">
            <a class="navlink" target="new" href="https://github.com/dhowe/dialogic/#dialogic">Home</a> &nbsp;|&nbsp;
            <a class="navlink" target="new" href="https://github.com/dhowe/dialogic/wiki/Command-Reference">Command Reference</a> &nbsp;|&nbsp;
            <a class="navlink" target="new" href="http://rednoise.org/dialogic/" rel="nofollow">API Documentation</a> &nbsp;|&nbsp;
            <a class="navlink" target="new" href="https://www.nuget.org/packages/org.rednoise.dialogic/" rel="nofollow">NuGet Package</a>
        </p>
        <img id="fish" src="http://rednoise.org/images/dialogic.png" width="32" />&nbsp;
        <span id="title">Dialogic</span><br>

  </span>
  <span id="errorLine" style="display:none;">%%ERRORLINE%%</span>
  <form name="main" id="form">
    <div class="input-area">
      <textarea id="main" name="code" class="lined" rows="29" cols="100" spellcheck="false">%%CODE%%</textarea>
      <div class="handle">
      </div>

    </div>
    <div id="button-div" class="validate">
      <button class="button" type="submit" id="validate" disabled title="validate the syntax of your script">Validate</button>
      <button class="button" type="submit" id="execute" disabled title="run the highlighted portion of the script">Execute</button>
      <button class="button" type="button" id="showDialog" title="Load from Url">Load URL</button>
     <!--  <button class="button" type="button" id="loadFromCookie" disabled title="Load from Cookie">Load From Cookie</button> -->
      <button class="button" type="reset" id="clear">Clear</button>
      <!--input type="checkbox" class="checkbox" name="useValidators" value="true" checked><span id="checkText">Use TendAr Validators</span><br-->
    </div>
  </form>

  <section id="result-container" class="%%CCLASS%%">
    <pre id="executeResult" style="font-size: 13px" class="executeResult %%RCLASS%%">%%EXECUTE%%</pre>
    <pre id="result" style="font-size: 13px" class="%%RCLASS%%">%%RESULT%%</pre>
  </section>
  <div class="CodeMirror-dialog" id="loadURLDialog">
    <div class="CodeMirror-dialog-top">
      <h4>Enter Url</h4>
    </div>
    <form id="loadUrlPathDiv" class="dialog-content">
      <input type="text" name="path" id="urlPath" placeholder="Paste your url">
    </form>
    <div class="CodeMirror-dialog-bottom">
      <div class="buttonset">
        <button type="button" id="loadURL">Load</button>
        <button type="button" id="clearURL">Clear</button>
        <button type="button" id="closeDialog">Cancel</button>
      </div>
    </div>
  </div>
  <script>

    $(function ()
    {
      // ******** Editor Related ************//

      var myTextarea = $("#main")[0];
      var editor = CodeMirror.fromTextArea(myTextarea, {
              lineNumbers: true,
              styleSelectedText: true
      });

      loadFromCookie();

      editor.on("change", function(cm, change) {

        // update the textarea
        var content = editor.getValue();
        $("#main").val(content);
        toggleButtons(content);
        // save current change to cookie
        if( content != "Enter your script here") {
          $.cookie("guppyScript", content);
        }

        // change validate button if necessary
         if (content.length && content != 'Enter your script here')
        {
          $("#validate").prop("disabled", false);
        }
      })
      // ******** End Editor Related ************//

      // ******** Click Handlers ************//
      // setup button handlers
      $("#clear").click(function ()
      {
        editor.setValue("");
      });

      $("#execute").click(function ()
      {
        onButtonClicked(true);
      });

      $("#validate").click(function ()
      {
        onButtonClicked(false);
      });

      // handle dialog show/hide
      $("#showDialog").click(function ()
      {
        $("#loadURLDialog").show();
      });

      $("#loadURL").click(onLoadURLClicked);

      $("#clearURL").click(function ()
      {
        $("#urlPath").val('');
      });

      $("#closeDialog").click(closeURLDialog);
      // ******** End Click Handlers ************//

      adjustUI();

      // functions ---------------------------------------------
      function adjustUI()
      {
        toggleButtons(editor.getValue());
        highlightErrorLine();
      }

      function highlightErrorLine()
      {
        if (!$("#errorLine").text().includes("ERRORLINE")) {
          var idx = $("#errorLine").text() - 1;
          editor.addLineClass(idx, "background", 'line-error');
        }
      }

      function toggleButtons(input)
      {

        if (input.length && input != 'Enter your script here')
        {
          $("#validate").prop("disabled", false);
        }


        var resText = $("#result").text(),
          validated;

        // only show execute if validation is successfull
        if (resText.length && resText.indexOf('%RESULT%') < 0 && $("#result").attr('class') =="success")
        {
          $("#execute").prop("disabled", false);
          $("#validate").prop("disabled", true);
        }

     
      }

      function closeURLDialog()
      {
        $("#loadURLDialog").hide();
        $("#urlPath").html("Paste your url");
      }

      function onButtonClicked(execute)
      {
        event.preventDefault();

        var formData = $("#form").serializeArray();
        formData.push(
        {
          name: 'mode',
          value: execute ? 'execute' : 'validate'
        });

        if (!execute)
        {

           if (editor.somethingSelected())
          {
            var content = editor.getValue();
            var startIdx = editor.getCursor(true).line;
            var endIdx = editor.getCursor(false).line;
            
            formData.push(
            {
              name: "selectionStart",
              value: startIdx
            });
            formData.push(
            {
              name: "selectionEnd",
              value: endIdx
            });
            formData.push(
            {
              name: "selection",
              value: processSelectedText(content, startIdx, endIdx)
            });
          }
        }
        else
        {
          formData.push(
          {
            name: "selection",
            value: $("#result").text()
          });
        }

        sendRequest(formData);
      }

      function onLoadURLClicked()
      {
        sendRequest($("#loadUrlPathDiv").serialize());
      }

      function loadFromCookie()
      {  var cookieContent = $.cookie("guppyScript");
         if(cookieContent != undefined && cookieContent != 'Enter your script here')  {
           editor.setValue(cookieContent);
         }
         
      }

      function sendRequest(data)
      {
        $.ajax(
        {
          type: "POST",
          data: data,
          url: "%%URL%%",
          contentType: 'application/x-www-form-urlencoded',
          success: function (data)
          {
            document.open();
            document.write(data);
            document.close();
          }
        });
      }

      function processSelectedText(code, startIdx, endIdx)
      {
        if (code)
        {

          // we need to maintain correct line numbers for error-reporting,  
          // so if we have a partial selection, we comment out any lines 
          // NOT included in the highlighted portion
          if (startIdx != endIdx)
          {
            var lines = code.split("\n");

            for (var i = 0; i < lines.length; i++)
            {
              if (i < startIdx) lines[i] = "//" + lines[i];
              if (endIdx < i) lines[i] = "//" + lines[i];
            }
            return lines.join("\n");
          }
        }
      }

      // Verticle resize
      // Based on: https://jsfiddle.net/mindplay/rs2L2vtb/2/
      let $handle =  document.querySelector(".handle");
      let $container = document.querySelector(".CodeMirror");

      function height_of($el) {
        return parseInt(window.getComputedStyle($el).height.replace(/px$/, ""));
      }

      const MIN_HEIGHT = 200;

      var start_x;
      var start_y;
      var start_h;

      function on_drag(e) {
        var height = Math.max(MIN_HEIGHT, (start_h + e.y - start_y)) + "px";
        editor.setSize(null, height);
        $(".CodeMirror-gutters").height(height);
      }

      function on_release(e) {
        document.body.removeEventListener("mousemove", on_drag);
        window.removeEventListener("mouseup", on_release);
      }

      $handle.addEventListener("mousedown", function (e) {
        start_x = e.x;
        start_y = e.y;
        start_h = height_of($container);

        document.body.addEventListener("mousemove", on_drag);
        window.addEventListener("mouseup", on_release);
      });


    });
  </script>
</body>

</html>
